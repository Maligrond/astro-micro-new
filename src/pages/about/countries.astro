---
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import BackToPrevious from "@components/BackToPrevious.astro";
import fs from 'fs';
import path from 'path';

// Dynamically load countries from markdown files
const countriesDir = path.join(process.cwd(), 'src/content/countries');
const files = fs.readdirSync(countriesDir).filter(file => file.endsWith('.md'));

const countries = files.map(file => {
  const filePath = path.join(countriesDir, file);
  const content = fs.readFileSync(filePath, 'utf-8');
  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
  
  if (!frontmatterMatch) return null;
  
  const frontmatter = frontmatterMatch[1];
  const data: Record<string, any> = {};
  const frontmatterLines = frontmatter.split('\n');
  
  for (const line of frontmatterLines) {
    const [key, ...valueParts] = line.split(':');
    if (key && valueParts.length > 0) {
      const value = valueParts.join(':').trim();
      if (key === 'rating') {
        data[key] = parseInt(value);
      } else {
        data[key] = value.replace(/^["']|["']$/g, '');
      }
    }
  }
  
  return {
    id: file.replace('.md', ''),
    data
  };
}).filter(Boolean);

const sortedCountries = countries.sort((a, b) => new Date(b?.data?.date || 0).getTime() - new Date(a?.data?.date || 0).getTime());
---
<Layout title="–ì–æ—Ä–æ–¥–∞" description="–°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º.">
  <Container>
    <BackToPrevious />
    
    <div class="prose prose-lg dark:prose-invert max-w-none mt-10">
      <h1>–ü–æ—Å–µ—â—ë–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞</h1>
    </div>
    
    <p class="text-lg text-gray-600 dark:text-gray-400 mb-12">
      –ì–æ—Ä–æ–¥–∞, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —è –ø–æ–±—ã–≤–∞–ª.
    </p>
    <!-- Countries List -->
    <div class="space-y-1">
      {sortedCountries.map((country) => {
        return (
          <a
            href={`/countries/${country?.id || ''}`}
            class="block group no-underline"
          >
            <div class="flex items-center justify-between gap-4 py-2 px-3 rounded hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <span class="text-xl">{country?.data?.flag || 'üèôÔ∏è'}</span>
                <h3 class="font-medium text-black dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors truncate">
                  {country?.data?.title || 'Untitled'}
                </h3>
                <span class="text-xs text-gray-500 dark:text-gray-400">({country?.data?.country || 'Unknown Country'})</span>
              </div>
              <div class="flex items-center gap-2 font-medium text-gray-500 dark:text-gray-400 flex-shrink-0">
                <span class="group-hover:hidden">
                  {new Date(country?.data?.date || '').toLocaleDateString('ru-RU')}
                </span>
                <span class="hidden group-hover:inline text-blue-600 dark:text-blue-400">
                  –ë–æ–ª—å—à–µ –æ –≥–æ—Ä–æ–¥–µ
                </span>
                <span class="flex items-center ml-2">
                  {Array.from({ length: 5 }).map((_, i) => {
                    return (
                      <span
                        class={`text-sm ${i < (country?.data?.rating || 0) ? 'text-black dark:text-white' : 'text-gray-300 dark:text-gray-600'}`}
                      >
                        ‚òÖ
                      </span>
                    );
                  })}
                </span>
              </div>
            </div>
          </a>
        );
      })}
    </div>
  </Container>
</Layout>
